var app = angular.module('App', [
    'ngRoute',
    'ui.router',
    'ngAnimate',
    'duScroll',
    'angular-growl',
    'App.services'
]);

angular.module('App.services', []);
angular.module('App')
.animation('.reveal-animation', function() {
  return {
    enter: function(element, done) {
      element.css('display', 'none');
      element.fadeIn(500, done);
      return function() {
        element.stop();
      }
    },
    leave: function(element, done) {
      element.fadeOut(500, done)
      return function() {
        element.stop();
      }
    }
  }
})
angular.module('App')
.config(['growlProvider', function(growlProvider) {
    growlProvider.onlyUniqueMessages(false);
    growlProvider.globalTimeToLive(10000);
}]);
angular.module('App').config([ 
	'$stateProvider', '$urlRouterProvider', '$locationProvider',
	function($stateProvider, $urlRouterProvider, $locationProvider){
		$urlRouterProvider.otherwise('/');
		// $locationProvider.html5Mode(true);

		$stateProvider  
		.state('index', {
			url: '/',
			views: { 
				'@': {
					templateUrl:'partials/layout.html',
				},
				// 'navbar@index': { templateUrl: 'partials/navbar.html'},
				'video-player@index': { templateUrl: 'partials/video.html'},
				'footer@index': { templateUrl: 'partials/footer.html'}			}
		});
	}]);
angular.module('App')
    .controller('VideoController', [
        '$rootScope',
        '$scope',
        '$sce',
        '$timeout',
        'VideoService',
        function($rootScope, $scope, $sce, $timeout, VideoService) {
            $scope.video = video = VideoService.video;
            $scope.playing = playing = false;
            $scope.checkpoints = checkpoints = {
                launched: false,
                points: []
            };
            $scope.checkpoint = checkpoint = {};

            $scope.videoLink = "";

            localinterval = $timeout(function() {
                player = videojs('my-video-player', { /* Options */ }, function() {
                    console.log('Good to go!');
                });
            }, 1000);

            $scope.clickPlay = function() {
                if ($scope.playing) {
                    player.pause();
                } else {
                    player.play();
                }
                $scope.playing = !$scope.playing;
            };

            $scope.clickForward = function() {
                player.currentTime(player.currentTime() + 10);
            };
            $scope.clickBackward = function() {
                player.currentTime(player.currentTime() - 10);
            };

            $scope.startCheckpoint = function() {
                checkpoint.startTime = player.currentTime();
                player.play();
                checkpoints.launched = true;
            };

            $scope.stopCheckpoint = function() {
                checkpoint.endTime = player.currentTime();
                checkpoints.launched = false;
                checkpoints.points.push({
                    'start': checkpoint.startTime,
                    'end': checkpoint.endTime
                });
            };

            $scope.goToCheckpoint = function(index) {
                var cp = checkpoints.points[index];
                var endTime = cp.endTime;
                player.currentTime(cp.start);
                player.play();
                player.setTimeout(function() {
                    player.pause();
                }, (cp.end - cp.start) * 1000);
            };
            $scope.parseDirectLink = function() {
                console.log("testing " + $scope.videoLink);
                player.src({
                    'type': 'video/mp4',
                    src: $scope.videoLink
                }).play();
                checkpoints.points = [];
            };

            $scope.reset = function() {
                $scope.videoLink = "";
                player.src(video.sources);
                player.play();

            }
        }
    ]);

/**
 * Delwiv : seen here : http://stackoverflow.com/a/24684360
 * A generic confirmation for risky actions.
 * Usage: Add attributes: ng-really-message="Are you sure"? ng-really-click="takeAction()" function
 */
// angular.module('App').directive('ngReallyClick', [function() {
//     return {
//         restrict: 'A',
//         link: function(scope, element, attrs) {
//             element.bind('click', function() {
//                 var message = attrs.ngReallyMessage;
//                 if (message && confirm(message)) {
//                     scope.$apply(attrs.ngReallyClick);
//                 }
//             });
//         }
//     }
// }]);
angular.module('App.services').factory('VideoService', [
    '$rootScope',
    '$sce',
    function($rootScope, $sce) {
        var VideoService = {};
        VideoService.video = {
            poster: "http://video-js.zencoder.com/oceans-clip.png",
            sources: [{
                src: $sce.trustAsResourceUrl("http://video-js.zencoder.com/oceans-clip.mp4"),
                type: "video/mp4"
            }, {
                src: $sce.trustAsResourceUrl("http://video-js.zencoder.com/oceans-clip.webm"),
                type: "video/webm"
            }, {
                src: $sce.trustAsResourceUrl("http://video-js.zencoder.com/oceans-clip.ogv"),
                type: "video/ogv"
            }]
        };

        return VideoService;
    }
]);
